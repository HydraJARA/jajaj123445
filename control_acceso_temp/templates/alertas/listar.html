{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold" style="color:#016B61;letter-spacing:1px;">Gestión de Alertas</h2>
    {% if 'alertas.crear_alertas' in usuario_actual.permisos %}
    <a href="{{ url_for('crear_alerta') }}" class="btn btn-primary" style="background:#016B61;color:#E5E9C5;">
        <i class="bi bi-exclamation-circle"></i> Nueva Alerta
    </a>
    {% endif %}
</div>

<div class="card shadow mb-4" style="background:#70B2B2;color:#016B61;">
    <div class="card-body">
        <form method="get" class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Nivel</label>
                <select name="nivel" class="form-select" style="background:#000000;color:#ffffff;">
                    <option value="" {% if nivel_seleccionado == '' %}selected{% endif %}>Todos</option>
                    <option value="alto" {% if nivel_seleccionado == 'alto' %}selected{% endif %}>Alto</option>
                    <option value="medio" {% if nivel_seleccionado == 'medio' %}selected{% endif %}>Medio</option>
                    <option value="bajo" {% if nivel_seleccionado == 'bajo' %}selected{% endif %}>Bajo</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Desde</label>
                <input type="date" name="fecha_desde" value="{{ fecha_desde }}" class="form-control" style="background:#E5E9C5;color:#016B61;">
            </div>
            <div class="col-md-3">
                <label class="form-label">Hasta</label>
                <input type="date" name="fecha_hasta" value="{{ fecha_hasta }}" class="form-control" style="background:#E5E9C5;color:#016B61;">
            </div>
            <div class="col-md-3 text-end">
                <button type="submit" class="btn" style="background:#016B61;color:#E5E9C5;">
                    <i class="bi bi-funnel"></i> Filtrar
                </button>
                <a href="{{ url_for('listar_alertas') }}" class="btn btn-outline-secondary ms-2">Limpiar</a>
            </div>
        </form>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card" style="background:#9ECFD4;color:#016B61;">
            <div class="card-body">
                <h6 class="mb-1">Alertas Hoy</h6>
                <h3 class="fw-bold">{{ estadisticas.total or 0 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card" style="background:#016B61;color:#000000;">
            <div class="card-body text-center">
                <div class="text-muted small">Altas</div>
                <div class="fw-bold">{{ estadisticas.altas or 0 }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card" style="background:#016B61;color:#000000;">
            <div class="card-body text-center">
                <div class="text-muted small">Medias</div>
                <div class="fw-bold">{{ estadisticas.medias or 0 }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card" style="background:#016B61;color:#000000;">
            <div class="card-body text-center">
                <div class="text-muted small">Bajas</div>
                <div class="fw-bold">{{ estadisticas.bajas or 0 }}</div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow" style="background:#70B2B2;color:#016B61;">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle" style="background:#E5E9C5;color:#016B61;">
                <thead>
                    <tr style="background:#016B61;color:#E5E9C5;">
                        <th>ID</th>
                        <th>Descripción</th>
                        <th>Nivel</th>
                        <th>Usuario</th>
                        <th>Visitante</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for alerta in alertas %}
                    <tr>
                        <td>{{ alerta.id }}</td>
                        <td>{{ alerta.descripcion }}</td>
                        <td>
                            {% if alerta.nivel == 'alto' %}
                                <span class="badge badge-nivel-alto" style="color:#000 !important;">{{ alerta.nivel|capitalize }}</span>
                            {% elif alerta.nivel == 'medio' %}
                                <span class="badge badge-nivel-medio" style="color:#000 !important;">{{ alerta.nivel|capitalize }}</span>
                            {% else %}
                                <span class="badge badge-nivel-bajo" style="color:#000 !important;">{{ alerta.nivel|capitalize }}</span>
                            {% endif %}
                        </td>
                        <td>{{ alerta.usuario_nombre or 'Sistema' }}</td>
                        <td>{{ alerta.visitante_nombre or '-' }}</td>
                        <td>{{ alerta.fecha.strftime('%Y-%m-%d %H:%M') if alerta.fecha else '' }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                {% if 'alertas.eliminar_alertas' in usuario_actual.permisos %}
                                <a href="{{ url_for('eliminar_alerta', id=alerta.id) }}" class="btn btn-outline-danger" onclick="return confirm('¿Eliminar alerta?');">
                                    <i class="bi bi-trash"></i>
                                </a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="bi bi-bell fs-1 d-block mb-2" style="color:#016B61;"></i>
                            No se encontraron alertas
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}